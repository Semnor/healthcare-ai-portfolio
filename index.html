<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical ABx Assistant - Antibiotic Decision Support</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .screen {
            display: none;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 6px solid #f39c12;
        }

        .warning-box h3 {
            color: #d68910;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .warning-box ul {
            margin: 15px 0 15px 20px;
        }

        .warning-box li {
            margin: 8px 0;
            color: #8b4513;
        }

        .btn {
            background: linear-gradient(135deg, #00b894 0%, #00a3ff 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 10px 5px;
            min-width: 160px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c5ce7 0%, #fd79a8 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
        }

        .search-container {
            position: relative;
            margin: 20px 0;
        }

        .search-box {
            width: 100%;
            padding: 18px 50px 18px 20px;
            border: 2px solid #ddd;
            border-radius: 50px;
            font-size: 1.1em;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            border-color: #00b894;
            box-shadow: 0 0 0 3px rgba(0,184,148,0.1);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 1.2em;
        }

        .pathogen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .pathogen-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .pathogen-card:hover {
            border-color: #00b894;
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .pathogen-card h3 {
            color: #2E86AB;
            margin-bottom: 8px;
            font-size: 1.3em;
        }

        .pathogen-card p {
            color: #666;
            margin: 5px 0;
        }

        .pathogen-card .gram-stain {
            display: inline-block;
            background: #e9ecef;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-top: 10px;
        }

        .gram-positive { background: #d1ecf1; color: #0c5460; }
        .gram-negative { background: #f8d7da; color: #721c24; }

        .form-group {
            margin: 25px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #00b894;
        }

        select.form-control {
            cursor: pointer;
        }

        .recommendation-card {
            background: linear-gradient(135deg, #00b894 0%, #00a3ff 100%);
            color: white;
            padding: 25px;
            border-radius: 16px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .recommendation-card h3 {
            font-size: 1.4em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recommendation-card .dosing {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            backdrop-filter: blur(10px);
        }

        .alternative-card {
            background: linear-gradient(135deg, #6c5ce7 0%, #fd79a8 100%);
        }

        .warning-card {
            background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .warning-card h4 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .back-btn {
            background: rgba(0,0,0,0.1);
            color: #666;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(0,0,0,0.2);
            color: #333;
        }

        .clinical-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #00b894;
        }

        .clinical-summary h4 {
            color: #2E86AB;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .content {
                padding: 20px;
            }
            
            .pathogen-grid {
                grid-template-columns: 1fr;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00b894;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
            border-top: 1px solid #eee;
        }

        .emoji {
            font-size: 1.2em;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Disclaimer Screen -->
        <div class="screen active" id="disclaimer-screen">
            <div class="header">
                <h1>üè• Clinical ABx Assistant</h1>
                <p>Evidence-Based Antibiotic Decision Support - MRSA Pneumonia Guidelines Updated</p>
            </div>
            <div class="content">
                <div class="warning-box">
                    <h3>‚ö†Ô∏è IMPORTANT MEDICAL DISCLAIMER</h3>
                    <p><strong>This tool is intended EXCLUSIVELY for licensed healthcare professionals for clinical decision support only.</strong></p>
                    
                    <ul>
                        <li>‚úÖ I understand this does NOT replace clinical judgment</li>
                        <li>‚úÖ I will consider patient-specific factors and local resistance patterns</li>
                        <li>‚úÖ I am a licensed healthcare professional</li>
                        <li>‚úÖ I will verify recommendations against current guidelines</li>
                    </ul>
                    
                    <p><strong>By continuing, you acknowledge these limitations and agree to use this tool responsibly.</strong></p>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" id="agree-btn">
                        <span class="emoji">üîç</span> I Agree - Continue to App
                    </button>
                    <button class="btn btn-danger" id="exit-btn">
                        <span class="emoji">üö™</span> Exit
                    </button>
                </div>
            </div>
            
            <div class="footer">
                <p><strong>Clinical ABx Assistant v1.0</strong></p>
                <p>Based on current IDSA/ATS guidelines. Always verify against local protocols and antibiograms.</p>
                <p>Last updated: June 2025 | For healthcare professionals only</p>
            </div>
        </div>

        <!-- Search Screen -->
        <div class="screen" id="search-screen">
            <div class="header">
                <h1>üîç Find Pathogen</h1>
                <p>Search for bacterial pathogens</p>
            </div>
            <div class="content">
                <div class="search-container">
                    <input type="text" class="search-box" id="pathogen-search" placeholder="üîç Search bacteria (e.g., E. coli, Staph aureus, Strep pneumo)">
                    <span class="search-icon">üîç</span>
                </div>
                
                <div id="search-results" class="pathogen-grid"></div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="showScreen('scenarios-screen')">
                        <span class="emoji">üìã</span> Browse Clinical Scenarios
                    </button>
                </div>
            </div>
        </div>

        <!-- Clinical Context Screen -->
        <div class="screen" id="context-screen">
            <div class="header">
                <h1>üìã Clinical Context</h1>
                <p>Provide clinical information for recommendations</p>
            </div>
            <div class="content">
                <a href="#" class="back-btn" onclick="showScreen('search-screen')">‚Üê Back to Search</a>
                
                <div class="clinical-summary">
                    <h4>Selected Pathogen</h4>
                    <p id="selected-pathogen-display"></p>
                </div>

                <form id="clinical-form">
                    <div class="form-group">
                        <label for="infection-site">üìç Primary Infection Site</label>
                        <select class="form-control" id="infection-site" required>
                            <option value="">Select infection site...</option>
                            <option value="UTI">Urinary Tract</option>
                            <option value="CAP">Community-Acquired Pneumonia</option>
                            <option value="VAP">Ventilator-Associated Pneumonia (VAP) - Mechanical ventilation >48h</option>
                            <option value="NV-HAP">Non-Ventilator Hospital-Acquired Pneumonia - Hospital >48h, no ventilator</option>
                            <option value="Aspiration">Aspiration Pneumonia</option>
                            <option value="SSTI">Skin & Soft Tissue</option>
                            <option value="Intra-abdominal">Intra-abdominal</option>
                            <option value="Bacteremia">Bloodstream</option>
                            <option value="Meningitis">Central Nervous System</option>
                            <option value="Bone/Joint">Bone & Joint</option>
                            <option value="Other">Other</option>
                        </select>
                        <small style="color: #666; font-size: 0.9em; margin-top: 5px; display: block;">
                            üí° <strong>HAP Note:</strong> VAP (ventilated patients) and NV-HAP (non-ventilated) have different MDR risks and treatment approaches per 2016 IDSA/ATS guidelines.<br>
                            üö® <strong>MRSA Note:</strong> For MRSA pneumonia use Vancomycin/Linezolid. Clindamycin is for skin/soft tissue infections only.
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="severity">‚ö° Infection Severity</label>
                        <select class="form-control" id="severity" required>
                            <option value="">Select severity...</option>
                            <option value="Mild">Mild (Outpatient)</option>
                            <option value="Moderate">Moderate (Hospital Ward)</option>
                            <option value="Severe">Severe (ICU/Septic)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="patient-type">üë§ Patient Population</label>
                        <select class="form-control" id="patient-type" required>
                            <option value="">Select patient type...</option>
                            <option value="Adult">Adult (18-64 years)</option>
                            <option value="Elderly">Elderly (>65 years)</option>
                            <option value="Pediatric">Pediatric (<18 years)</option>
                            <option value="Pregnancy">Pregnancy</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="allergies">üö® Known Drug Allergies</label>
                        <input type="text" class="form-control" id="allergies" placeholder="e.g., Penicillin, Sulfa (leave blank if none)">
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button type="button" class="btn" id="get-recommendations-btn" onclick="handleGetRecommendations()">
                            <span class="emoji">üíä</span> Get Recommendations
                        </button>
                        <div id="loading-indicator" class="loader hidden"></div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Recommendations Screen -->
        <div class="screen" id="recommendations-screen">
            <div class="header">
                <h1>üíä Recommendations</h1>
                <p>Evidence-based antibiotic therapy</p>
            </div>
            <div class="content">
                <a href="#" class="back-btn" onclick="showScreen('context-screen')">‚Üê Back to Context</a>
                
                <div class="clinical-summary">
                    <h4>Clinical Summary</h4>
                    <p id="clinical-summary-text"></p>
                </div>

                <div id="recommendations-content"></div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="showScreen('search-screen')">
                        <span class="emoji">üîÑ</span> New Search
                    </button>
                    <button class="btn btn-secondary" onclick="shareRecommendation()">
                        <span class="emoji">üì±</span> Share
                    </button>
                </div>
            </div>
        </div>

        <!-- Scenarios Screen -->
        <div class="screen" id="scenarios-screen">
            <div class="header">
                <h1>üìã Clinical Scenarios</h1>
                <p>Common infection scenarios</p>
            </div>
            <div class="content">
                <a href="#" class="back-btn" onclick="showScreen('search-screen')">‚Üê Back to Search</a>
                
                <div class="pathogen-grid" id="scenarios-grid"></div>
            </div>
        </div>
    </div>

    <script>
        // Pathogen Database - CORRECTED FOR MEDICAL ACCURACY
        const pathogens = [
            {
                id: 1,
                name: "Escherichia coli",
                commonName: "E. coli",
                gramStain: "Negative",
                site: "UTI",
                severity: "Mild",
                firstLine: "Nitrofurantoin 100mg PO BID",
                alternative: "TMP-SMX DS PO BID",
                pediatric: "Nitrofurantoin 5-7mg/kg/day PO div BID",
                duration: "5 days",
                notes: "Avoid TMP-SMX if local resistance >20%. Nitrofurantoin preferred for uncomplicated UTI.",
                resistance: "ESBL producers increasing. TMP-SMX resistance common."
            },
            {
                id: 14,
                name: "Staphylococcus aureus",
                commonName: "MRSA Pneumonia",
                gramStain: "Positive",
                site: "CAP",
                severity: "Severe",
                firstLine: "Vancomycin 15mg/kg IV q12h",
                alternative: "Linezolid 600mg IV/PO q12h",
                pediatric: "Vancomycin 15mg/kg IV q6h",
                duration: "7-10 days",
                notes: "MRSA PNEUMONIA: Vancomycin or Linezolid only per IDSA/ATS guidelines. NOT Clindamycin.",
                resistance: "Target vancomycin AUC 400-600. Linezolid superior lung penetration."
            },
            {
                id: 2,
                name: "Staphylococcus aureus",
                commonName: "MSSA",
                gramStain: "Positive",
                site: "SSTI",
                severity: "Mild",
                firstLine: "Cephalexin 500mg PO QID",
                alternative: "Clindamycin 300mg PO TID",
                pediatric: "Cephalexin 25-50mg/kg/day PO div QID",
                duration: "7 days",
                notes: "Confirm MSSA by culture. Cephalexin first-choice for cellulitis.",
                resistance: "Check clindamycin D-test if using for severe infections"
            },
            {
                id: 3,
                name: "Staphylococcus aureus",
                commonName: "MRSA (SSTI)",
                gramStain: "Positive",
                site: "SSTI",
                severity: "Mild",
                firstLine: "Clindamycin 300-450mg PO TID",
                alternative: "Doxycycline 100mg PO BID",
                pediatric: "Clindamycin 10-13mg/kg/day PO div TID",
                duration: "7 days",
                notes: "SKIN/SOFT TISSUE ONLY. Check D-test for inducible clindamycin resistance. NOT for pneumonia.",
                resistance: "For MRSA pneumonia: use Vancomycin or Linezolid per IDSA/ATS - NEVER Clindamycin"
            },
            {
                id: 4,
                name: "Streptococcus pneumoniae",
                commonName: "Pneumococcus",
                gramStain: "Positive",
                site: "CAP",
                severity: "Moderate",
                firstLine: "Amoxicillin 875mg PO BID",
                alternative: "Azithromycin 500mg PO daily x5d",
                pediatric: "Amoxicillin 90mg/kg/day PO div BID",
                duration: "5-7 days",
                notes: "High-dose amoxicillin for penicillin-intermediate strains",
                resistance: "Macrolide resistance increasing. Fluoroquinolone resistance rare."
            },
            {
                id: 5,
                name: "Pseudomonas aeruginosa",
                commonName: "Pseudomonas",
                gramStain: "Negative",
                site: "HAP",
                severity: "Severe",
                firstLine: "Piperacillin-tazobactam 4.5g IV q6h + Vancomycin 15mg/kg IV q12h",
                alternative: "Cefepime 2g IV q8h + Linezolid 600mg IV/PO q12h",
                pediatric: "Pip-tazo 300mg/kg/day IV + Vancomycin 15mg/kg IV q6h",
                duration: "7 days",
                notes: "Dual therapy recommended for high-risk patients. Always cover MRSA in HAP.",
                resistance: "High intrinsic resistance. Avoid monotherapy."
            },
            {
                id: 6,
                name: "Enterococcus faecalis",
                commonName: "Enterococcus",
                gramStain: "Positive",
                site: "UTI",
                severity: "Mild",
                firstLine: "Amoxicillin 500mg PO TID",
                alternative: "Nitrofurantoin 100mg PO BID",
                pediatric: "Amoxicillin 50mg/kg/day PO div TID",
                duration: "7 days",
                notes: "Ampicillin preferred IV if available. Nitrofurantoin for uncomplicated UTI only.",
                resistance: "VRE (vancomycin-resistant enterococcus) emerging"
            },
            {
                id: 7,
                name: "Klebsiella pneumoniae",
                commonName: "Klebsiella",
                gramStain: "Negative",
                site: "UTI",
                severity: "Moderate",
                firstLine: "Ceftriaxone 1g IV daily",
                alternative: "Ertapenem 1g IV daily",
                pediatric: "Ceftriaxone 50mg/kg/day IV",
                duration: "7-10 days",
                notes: "High ESBL risk - obtain cultures and susceptibilities",
                resistance: "ESBL producers common. KPC carbapenemase resistance increasing."
            },
            {
                id: 8,
                name: "Mixed anaerobes",
                commonName: "Aspiration pneumonia",
                gramStain: "Mixed",
                site: "Aspiration",
                severity: "Moderate",
                firstLine: "Ceftriaxone 1g IV daily",
                alternative: "Levofloxacin 750mg PO/IV daily",
                pediatric: "Ceftriaxone 50mg/kg/day IV",
                duration: "7-10 days",
                notes: "Routine anaerobic coverage NOT recommended per current guidelines",
                resistance: "Clindamycin increases C. diff risk - avoid routine use"
            },
            {
                id: 9,
                name: "Haemophilus influenzae",
                commonName: "H. flu",
                gramStain: "Negative",
                site: "CAP",
                severity: "Mild",
                firstLine: "Amoxicillin-clavulanate 875mg PO BID",
                alternative: "Azithromycin 500mg PO daily x5d",
                pediatric: "Amoxicillin-clav 45mg/kg/day PO div BID",
                duration: "5-7 days",
                notes: "Beta-lactamase production in 30-40% of strains",
                resistance: "Ampicillin resistance due to beta-lactamase production"
            },
            {
                id: 10,
                name: "Streptococcus pyogenes",
                commonName: "Group A Strep",
                gramStain: "Positive",
                site: "SSTI",
                severity: "Moderate",
                firstLine: "Penicillin VK 500mg PO BID",
                alternative: "Clindamycin 300mg PO TID",
                pediatric: "Penicillin VK 25-50mg/kg/day PO div BID-TID",
                duration: "10 days",
                notes: "Penicillin V oral for mild-moderate. Clindamycin for severe (toxin suppression).",
                resistance: "No penicillin resistance reported. Rare macrolide/clindamycin resistance."
            },
            {
                id: 11,
                name: "Mycoplasma pneumoniae",
                commonName: "Mycoplasma",
                gramStain: "Atypical",
                site: "CAP",
                severity: "Mild",
                firstLine: "Azithromycin 500mg PO x1, then 250mg PO daily",
                alternative: "Doxycycline 100mg PO BID",
                pediatric: "Azithromycin 10mg/kg PO x1, then 5mg/kg PO daily",
                duration: "5 days total",
                notes: "Atypical pneumonia. 'Walking pneumonia' in young adults.",
                resistance: "Intrinsically resistant to all beta-lactams"
            }
        ];

        // Clinical scenarios - UPDATED TO MATCH CORRECTED DATA
        const scenarios = [
            {
                id: 1,
                name: "Uncomplicated UTI (Female)",
                pathogens: "E. coli (80%)",
                empiric: "Nitrofurantoin 100mg PO BID x5d",
                icon: "ü´ß"
            },
            {
                id: 2,
                name: "Community-Acquired Pneumonia",
                pathogens: "S. pneumoniae, H. influenzae",
                empiric: "Amoxicillin 875mg PO BID x5-7d",
                icon: "ü´Å"
            },
            {
                id: 3,
                name: "Cellulitis (Non-purulent)",
                pathogens: "S. pyogenes, S. agalactiae",
                empiric: "Cephalexin 500mg PO QID x7d",
                icon: "ü©π"
            },
            {
                id: 4,
                name: "Hospital-Acquired Pneumonia",
                pathogens: "Pseudomonas, MRSA",
                empiric: "Pip-tazo + Vancomycin IV",
                icon: "üè•"
            },
            {
                id: 5,
                name: "Aspiration Pneumonia",
                pathogens: "Mixed aerobes (anaerobic coverage usually NOT needed)",
                empiric: "Ceftriaxone 1g IV daily x7-10d",
                icon: "ü§¢"
            },
            {
                id: 6,
                name: "Strep Throat",
                pathogens: "Group A Streptococcus",
                empiric: "Penicillin VK 500mg PO BID x10d",
                icon: "ü¶†"
            }
        ];

        // Current state
        let selectedPathogen = null;
        let clinicalContext = {};

        // Show screen function
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            // Initialize screen-specific content
            if (screenId === 'search-screen') {
                initializeSearch();
            } else if (screenId === 'scenarios-screen') {
                initializeScenarios();
            }
        }

        // Initialize search functionality
        function initializeSearch() {
            const searchBox = document.getElementById('pathogen-search');
            const resultsDiv = document.getElementById('search-results');
            
            // Display all pathogens initially
            displayPathogens(pathogens);
            
            // Search functionality
            searchBox.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (query.length === 0) {
                    displayPathogens(pathogens);
                } else {
                    const filtered = pathogens.filter(pathogen => 
                        pathogen.name.toLowerCase().includes(query) ||
                        pathogen.commonName.toLowerCase().includes(query) ||
                        pathogen.site.toLowerCase().includes(query) ||
                        // Enhanced search for HAP-related terms
                        (query.includes('hospital') && (pathogen.site.includes('VAP') || pathogen.site.includes('NV-HAP'))) ||
                        (query.includes('ventilator') && pathogen.site.includes('VAP')) ||
                        (query.includes('hap') && (pathogen.site.includes('VAP') || pathogen.site.includes('NV-HAP'))) ||
                        (query.includes('pneumonia') && (pathogen.site.includes('CAP') || pathogen.site.includes('VAP') || pathogen.site.includes('NV-HAP') || pathogen.site.includes('Aspiration'))) ||
                        (query.includes('pseudomonas') && pathogen.name.includes('aeruginosa')) ||
                        // Enhanced MRSA search
                        (query.includes('mrsa') && pathogen.commonName.toLowerCase().includes('mrsa')) ||
                        (query.includes('resistant') && pathogen.commonName.toLowerCase().includes('mrsa'))
                    );
                    displayPathogens(filtered);
                }
            });
        }

        // Display pathogens
        function displayPathogens(pathogenList) {
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '';
            
            pathogenList.forEach(pathogen => {
                const card = document.createElement('div');
                card.className = 'pathogen-card';
                card.onclick = () => selectPathogen(pathogen);
                
                card.innerHTML = `
                    <h3>${pathogen.commonName}</h3>
                    <p><strong>${pathogen.name}</strong></p>
                    <span class="gram-stain gram-${pathogen.gramStain.toLowerCase()}">${pathogen.gramStain}</span>
                `;
                
                resultsDiv.appendChild(card);
            });
        }

        // Select pathogen
        function selectPathogen(pathogen) {
            selectedPathogen = pathogen;
            document.getElementById('selected-pathogen-display').textContent = 
                `${pathogen.commonName} (${pathogen.name}) - ${pathogen.site}`;
            showScreen('context-screen');
        }

        // Initialize scenarios
        function initializeScenarios() {
            const scenariosGrid = document.getElementById('scenarios-grid');
            scenariosGrid.innerHTML = '';
            
            scenarios.forEach(scenario => {
                const card = document.createElement('div');
                card.className = 'pathogen-card';
                card.onclick = () => selectScenario(scenario);
                
                card.innerHTML = `
                    <h3>${scenario.icon} ${scenario.name}</h3>
                    <p><strong>Common pathogens:</strong> ${scenario.pathogens}</p>
                    <p><strong>Empiric therapy:</strong> ${scenario.empiric}</p>
                `;
                
                scenariosGrid.appendChild(card);
            });
        }

        // Select scenario
        function selectScenario(scenario) {
            // Find matching pathogen based on scenario
            let pathogen;
            
            if (scenario.name.includes("UTI")) {
                pathogen = pathogens.find(p => p.commonName.toLowerCase().includes("e. coli"));
            } else if (scenario.name.includes("Community-Acquired Pneumonia")) {
                pathogen = pathogens.find(p => p.commonName.toLowerCase().includes("pneumococcus"));
            } else if (scenario.name.includes("Cellulitis")) {
                pathogen = pathogens.find(p => p.commonName.toLowerCase().includes("mssa"));
            } else if (scenario.name.includes("Ventilator-Associated")) {
                pathogen = pathogens.find(p => p.commonName.toLowerCase().includes("pseudomonas (vap)"));
            } else if (scenario.name.includes("Non-Ventilator HAP (Low Risk)")) {
                pathogen = pathogens.find(p => p.commonName.toLowerCase().includes("nv-hap (low risk)"));
            } else if (scenario.name.includes("Non-Ventilator HAP (High Risk)")) {
                pathogen = pathogens.find(p => p.commonName.toLowerCase().includes("nv-hap (high risk)"));
            } else if (scenario.name.includes("Aspiration")) {
                pathogen = pathogens.find(p => p.commonName.toLowerCase().includes("aspiration"));
            } else if (scenario.name.includes("Strep Throat")) {
                pathogen = pathogens.find(p => p.commonName.toLowerCase().includes("group a strep"));
            } else if (scenario.name.includes("MRSA Pneumonia")) {
                pathogen = pathogens.find(p => p.commonName.toLowerCase().includes("mrsa pneumonia"));
            } else {
                // Default to first pathogen
                pathogen = pathogens[0];
            }
            
            if (pathogen) {
                selectPathogen(pathogen);
            }
        }

        // Handle get recommendations button click
        function handleGetRecommendations() {
            console.log('Get Recommendations button clicked!');
            
            // Show loading indicator
            const btn = document.getElementById('get-recommendations-btn');
            const loader = document.getElementById('loading-indicator');
            btn.style.display = 'none';
            loader.classList.remove('hidden');
            
            // Validate that we have a selected pathogen
            if (!selectedPathogen) {
                alert('Please select a pathogen first!');
                btn.style.display = 'inline-block';
                loader.classList.add('hidden');
                showScreen('search-screen');
                return;
            }
            
            // Get form values
            const site = document.getElementById('infection-site').value;
            const severity = document.getElementById('severity').value;
            const patientType = document.getElementById('patient-type').value;
            const allergies = document.getElementById('allergies').value;
            
            console.log('Form values:', { site, severity, patientType, allergies });
            
            // Validate required fields
            if (!site || !severity || !patientType) {
                alert('Please fill in all required fields:\n- Infection Site\n- Severity\n- Patient Type');
                btn.style.display = 'inline-block';
                loader.classList.add('hidden');
                return;
            }
            
            clinicalContext = {
                site: site,
                severity: severity,
                patientType: patientType,
                allergies: allergies
            };
            
            console.log('Clinical context:', clinicalContext);
            console.log('Selected pathogen:', selectedPathogen);
            
            // Generate recommendations after short delay
            setTimeout(() => {
                try {
                    generateRecommendations();
                    btn.style.display = 'inline-block';
                    loader.classList.add('hidden');
                    showScreen('recommendations-screen');
                    console.log('Successfully generated recommendations!');
                } catch (error) {
                    console.error('Error generating recommendations:', error);
                    alert('Error generating recommendations. Please try again.');
                    btn.style.display = 'inline-block';
                    loader.classList.add('hidden');
                }
            }, 500);
        }

        // Handle clinical form submission (backup method)
        document.getElementById('clinical-form').addEventListener('submit', function(e) {
            e.preventDefault();
            handleGetRecommendations();
        });

        // Generate recommendations
        function generateRecommendations() {
            if (!selectedPathogen) {
                console.error('No pathogen selected');
                return;
            }
            
            const summaryText = `${clinicalContext.patientType} with ${clinicalContext.severity} ${selectedPathogen.commonName} ${clinicalContext.site}`;
            document.getElementById('clinical-summary-text').textContent = summaryText;
            
            const recommendationsDiv = document.getElementById('recommendations-content');
            
            const pediatricSection = clinicalContext.patientType === 'Pediatric' ? `
                <div class="recommendation-card" style="background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);">
                    <h3><span class="emoji">üë∂</span> PEDIATRIC DOSING</h3>
                    <div class="dosing">
                        <strong>${selectedPathogen.pediatric}</strong>
                        <p>Duration: ${selectedPathogen.duration}</p>
                    </div>
                </div>
            ` : '';
            
            const allergyNote = clinicalContext.allergies ? `<p><strong>Allergies Noted:</strong> ${clinicalContext.allergies} - Verify drug compatibility!</p>` : '';
            
            recommendationsDiv.innerHTML = `
                <div class="recommendation-card">
                    <h3><span class="emoji">ü•á</span> FIRST-LINE CHOICE</h3>
                    <div class="dosing">
                        <strong>${selectedPathogen.firstLine}</strong>
                        <p>Duration: ${selectedPathogen.duration}</p>
                    </div>
                </div>
                
                <div class="recommendation-card alternative-card">
                    <h3><span class="emoji">ü•à</span> ALTERNATIVE OPTION</h3>
                    <div class="dosing">
                        <strong>${selectedPathogen.alternative}</strong>
                        <p>Duration: ${selectedPathogen.duration}</p>
                    </div>
                </div>
                
                ${pediatricSection}
                
                <div class="warning-card">
                    <h4><span class="emoji">‚ö†Ô∏è</span> Important Considerations</h4>
                    <p><strong>Clinical Notes:</strong> ${selectedPathogen.notes}</p>
                    <p><strong>Resistance Patterns:</strong> ${selectedPathogen.resistance}</p>
                    ${allergyNote}
                    <p><strong>Always verify:</strong> Local antibiogram, renal function, drug interactions</p>
                    <p><strong>Evidence base:</strong> Current IDSA/ATS/CDC guidelines (2024-2025)</p>
                    <p><strong>üö® MRSA Warning:</strong> Clindamycin is for MRSA skin/soft tissue infections ONLY. For MRSA pneumonia: use Vancomycin or Linezolid per IDSA/ATS guidelines.</p>
                </div>
            `;
            
            console.log('Recommendations generated successfully');
        }

        // Share recommendation
        function shareRecommendation() {
            const text = `Clinical ABx Recommendation:\n${selectedPathogen.commonName} ${clinicalContext.site}\nFirst-line: ${selectedPathogen.firstLine}\nDuration: ${selectedPathogen.duration}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Antibiotic Recommendation',
                    text: text
                });
            } else {
                // Fallback for browsers that don't support Web Share API
                navigator.clipboard.writeText(text).then(() => {
                    alert('Recommendation copied to clipboard!');
                });
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initialized');
            showScreen('disclaimer-screen');
            
            // Add event listeners for disclaimer buttons
            document.getElementById('agree-btn').addEventListener('click', function() {
                console.log('Agree button clicked');
                showScreen('search-screen');
            });
            
            document.getElementById('exit-btn').addEventListener('click', function() {
                alert('Thank you for using Clinical ABx Assistant responsibly.');
            });
            
            // Pre-load search functionality
            setTimeout(() => {
                initializeSearch();
                initializeScenarios();
            }, 100);
        });
    </script>
</body>
</html>
